---
version: 1.0
tasks:
  # Expand the OS partition and set up the Samba share
  - task: executeScript
    inputs:
      - frequency: always
        type: powershell
        runAs: localSystem
        content: |-
          $DiskPath = (Get-Partition -DiskNumber 0).DiskPath
          if ((Get-Partition -DiskId $DiskPath).Count -gt 2) {
            "select disk 0`nselect partition 2`nextend`n" | diskpart.exe
          }
          $SambaServer = ("${samba_server_input}" -split ",")[0]
          if (
            ($SambaServer -ne "") -and
            (-not
              (Get-PSDrive "${drive_letter}" -ErrorAction "SilentlyContinue")
            )
          )
          {
            New-PSDrive -Name "${drive_letter}" `
              -Root "\\$SambaServer\share" `
              -PSProvider "FileSystem" `
              -Persist
          }
